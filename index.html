<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bmass Profiles</title>

    <!-- Meta SEO, Libraries, Fonts -->
    <meta name="description" content="T·∫°o v√† chia s·∫ª trang c√° nh√¢n Web3 c·ªßa b·∫°n m·ªôt c√°ch d·ªÖ d√†ng.">
    <link rel="icon" href="https://bmass.vercel.app/img/bmasslogo.png" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <!-- NEW: SortableJS for Drag & Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

</head>
<style>
    :root {
        --accent-primary: #915EFF;
        --accent-secondary: #2BCBC4;
        --text-primary: #212529;
        --text-secondary: #6c757d;
        --color-verified: #007bff;
        --card-bg: rgba(255, 255, 255, 0.1);
        --transition-smooth: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        --shadow-light: 0 4px 15px rgba(0,0,0,0.07);
        --shadow-strong: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
    }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); } }

    body {
        font-family: 'Poppins', sans-serif;
        color: var(--text-primary);
        transition: background-color 0.3s;
        overflow: hidden;
        margin: 0;
    }
    
    #particles-js {
        position: fixed;
        width: 100%;
        height: 100%;
        z-index: -1;
        background-color: #000000;
        background-image: linear-gradient(45deg, #000000 0%, #1a0a24 100%);
    }

    /* === Header & Sidebar === */
    .header-controls { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 1050; }
    .sidebar-toggle {
        background: white; border: none; border-radius: 50%; width: 50px; height: 50px;
        font-size: 1.2rem; box-shadow: var(--shadow-light); transition: var(--transition-smooth);
        display: flex; align-items: center; justify-content: center;
    }
    .sidebar-toggle:hover { transform: scale(1.1); box-shadow: var(--shadow-strong); }
    .sidebar {
        position: fixed; top: 0; left: 0; height: 100%; width: 280px;
        background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); z-index: 1051;
        transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: 0 0 50px rgba(0,0,0,0.1); padding: 2rem 1.5rem; display: flex; flex-direction: column;
    }
    .sidebar.open { transform: translateX(0); }
    .sidebar-header { font-weight: 600; font-size: 1.5rem; margin-bottom: 2rem; }
    .sidebar-link {
        display: block; padding: 0.8rem 1rem; border-radius: 10px; color: var(--text-primary);
        text-decoration: none; font-weight: 500; margin-bottom: 0.5rem; transition: background-color 0.3s, color 0.3s;
    }
    .sidebar-link:hover { background-color: #f0f2f5; }
    .sidebar-link i { margin-right: 12px; width: 20px; text-align: center; }
    .sidebar-link.logout { margin-top: auto; color: #dc3545; }
    .sidebar-link.logout:hover { background-color: #fdf2f3; }
    .overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4);
        z-index: 1045; opacity: 0; visibility: hidden; transition: opacity 0.4s, visibility 0.4s;
    }
    .overlay.show { opacity: 1; visibility: visible; }

    /* === Main Container & Views === */
    .main-container { padding: 2rem 1rem; margin: auto; height: 100vh; overflow-y: auto; }
    .view { display: none; animation: fadeIn 0.6s; }
    .view-center-content {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }
    #email-verification-banner {
        position: sticky;
        top: 0;
        z-index: 1040;
    }

    /* === Profile View === */
    .card-glass {
        position: relative; background: var(--card-bg); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 25px; padding: 2rem; box-shadow: var(--shadow-strong); color: #fff;
    }
    .profile-avatar { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 5px solid white; box-shadow: 0 0 20px rgba(0,0,0,0.15); margin-top: -95px; }
    .profile-name-wrapper { display: flex; align-items: center; justify-content: center; gap: 10px; }
    .profile-name { font-size: 2rem; font-weight: 700; margin-bottom: 0; }
    .verified-tick { color: var(--color-verified); font-size: 1.6rem; background: white; border-radius: 50%; padding: 2px; box-shadow: 0 2px 5px rgba(0,123,255,0.3); }
    .social-links { display: flex; justify-content: center; flex-wrap: wrap; gap: 1rem; margin-top: 1.5rem; }
    .social-link { font-size: 1.5rem; color: #fff; transition: var(--transition-smooth); width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); text-decoration: none; }
    .social-link:hover { transform: translateY(-5px); color: white; background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary)); box-shadow: 0 4px 15px rgba(145, 94, 255, 0.4); }
    .project-card { display: flex; align-items: center; text-decoration: none; color: var(--text-primary); background: rgba(255, 255, 255, 0.9); padding: 1rem; border-radius: 15px; border: 1px solid #dee2e6; transition: var(--transition-smooth); box-shadow: var(--shadow-light); cursor: pointer; }
    .project-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 8px 25px rgba(145, 94, 255, 0.15); border-color: var(--accent-primary); }
    .project-icon { width: 64px; height: 64px; border-radius: 12px; object-fit: cover; margin-right: 1rem; flex-shrink: 0; }
    #edit-profile-btn { position: absolute; bottom: -25px; right: 2rem; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary)); color: white; font-size: 1.5rem; display: none; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; transition: transform 0.3s; }
    #edit-profile-btn:hover { transform: scale(1.1); }
    
    .project-card-content {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        align-items: flex-start;
        flex-grow: 1;
        min-height: 64px;
    }
    .project-clicks {
        align-self: flex-end;
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-top: 8px;
    }

    /* === Category Tabs Styling === */
    .category-tabs-container {
        padding: 1rem 0;
        margin-top: 2rem;
        position: relative;
    }
    .category-tabs {
        display: flex;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        flex-wrap: nowrap;
        overflow-x: auto;
        justify-content: flex-start;
        -ms-overflow-style: none; 
        scrollbar-width: none; 
    }
    .category-tabs::-webkit-scrollbar {
        display: none;
    }

    .category-tab {
        padding: 10px 20px;
        cursor: pointer;
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 500;
        font-size: 1rem;
        transition: color 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
    }
    .category-tab.active {
        color: #fff;
    }
    .category-tab:hover {
        color: #fff;
    }
    .rename-category-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        padding: 0;
        margin-left: 0;
        font-size: 0.8em;
        opacity: 0;
        transition: opacity 0.3s, color 0.3s;
    }
    .category-tab:hover .rename-category-btn {
        opacity: 1;
    }
    .rename-category-btn:hover {
        color: var(--accent-secondary);
    }
    #add-category-btn {
        background-color: rgba(255,255,255,0.1);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        margin-left: 15px;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .tab-underline {
        position: absolute;
        bottom: -1px;
        left: 0;
        height: 3px;
        background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
        border-radius: 3px;
        transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    .category-content-container { padding-top: 1.5rem; }
    .category-content { display: none; animation: fadeInUp 0.5s; }
    .category-content.active { display: block; }

    /* === Auth Views: Flip Card & Forms === */
    .flip-card {
        background-color: transparent; width: 100%; max-width: 420px;
        height: 620px;
    }
    .flip-card-inner {
        position: relative; width: 100%; height: 100%; text-align: center;
        transition: transform 0.8s; transform-style: preserve-3d;
    }
    .flip-card.is-flipped .flip-card-inner { transform: rotateY(180deg); }
    .flip-card-front, .flip-card-back {
        position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden;
        border-radius: 20px; overflow: hidden; box-shadow: var(--shadow-strong);
        background: var(--card-bg); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .flip-card-back { transform: rotateY(180deg); }
    .auth-header {
        background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
        color: white; padding: 2rem;
    }
    .auth-header h2 { font-weight: 700; margin-bottom: 0.5rem;}
    .auth-body { padding: 1.5rem 2rem; }
    .form-control {
        border-radius: 10px; padding: 0.9rem 1rem; border: 1px solid rgba(255, 255, 255, 0.2);
        transition: border-color 0.3s, box-shadow 0.3s; background: rgba(255, 255, 255, 0.1); color: #fff;
    }
    .form-control::placeholder { color: rgba(255, 255, 255, 0.7); }
    .form-control:focus {
        border-color: var(--accent-primary); box-shadow: 0 0 0 0.25rem rgba(145, 94, 255, 0.25);
        background: rgba(255, 255, 255, 0.2);
    }
    .btn-submit-grad {
        background-size: 200% auto;
        background-image: linear-gradient(to right, var(--accent-primary) 0%, var(--accent-secondary) 51%, var(--accent-primary) 100%);
        border: none; border-radius: 10px; padding: 0.9rem; font-weight: 600; color: white;
        width: 100%; transition: 0.5s;
    }
    .btn-submit-grad:hover { background-position: right center; transform: translateY(-3px); box-shadow: 0 6px 20px rgba(145, 94, 255, 0.4); }
    .btn-google {
        background: #fff; color: #757575; border: 1px solid #ddd;
    }
    .btn-google:hover { background: #f8f8f8; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .auth-switch-link, .forgot-password-link {
        background: none; border: none; color: var(--accent-secondary); text-decoration: none;
        font-weight: 600; cursor: pointer; padding: 0;
    }
    .auth-switch-link:hover, .forgot-password-link:hover { text-decoration: underline; }
    #auth-status { min-height: 24px; margin-top: 1rem; color: #ffcdd2; }
    .divider { display: flex; align-items: center; text-align: center; color: rgba(255,255,255,0.5); margin: 1.5rem 0;}
    .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid rgba(255,255,255,0.2); }
    .divider:not(:empty)::before { margin-right: .5em; }
    .divider:not(:empty)::after { margin-left: .5em; }

    /* === General & Footer === */
    .footer-section { padding: 2rem 1rem; color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; margin-top: 2rem; }
    .spinner-border { color: var(--accent-primary); }

    /* === MODAL STYLING === */
    .modal .form-control, .modal .form-select {
        background-color: #f8f9fa;
        color: var(--text-primary);
        border: 1px solid #ced4da;
    }
    .modal .form-control::placeholder { color: #6c757d; }
    .modal .form-control:focus, .modal .form-select:focus {
        color: var(--text-primary);
        background-color: #fff;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 0.25rem rgba(145, 94, 255, 0.25);
    }
    
    /* === Project Detail Modal Styling === */
    #projectDetailModal .modal-content {
        border-radius: 1rem;
        border: none;
        box-shadow: var(--shadow-strong);
    }
    #projectDetailModal .modal-header {
        border-bottom: none;
        padding: 1.5rem 1.5rem 0.5rem;
    }
    #projectDetailModal .modal-body {
        padding: 0.5rem 1.5rem 1.5rem;
    }
    .project-detail-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    #project-detail-icon {
        width: 80px;
        height: 80px;
        border-radius: 16px;
        object-fit: cover;
        box-shadow: var(--shadow-light);
        flex-shrink: 0;
    }
    #project-detail-name {
        font-weight: 700;
        font-size: 1.75rem;
        margin-bottom: 0.25rem;
    }
    #project-detail-category {
        font-size: 0.9rem;
        padding: 0.25rem 0.6rem;
        border-radius: 0.5rem;
        background-color: #e9ecef;
        color: var(--text-secondary);
        font-weight: 500;
    }
    #project-detail-description {
        color: var(--text-primary);
        font-size: 1rem;
        margin-bottom: 1.5rem;
    }
    #project-detail-stats {
        display: flex;
        justify-content: space-around;
        text-align: center;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.75rem;
        margin-bottom: 1.5rem;
    }
    .stat-item h6 {
        margin-bottom: 0.25rem;
        font-weight: 700;
        font-size: 1.25rem;
        color: var(--accent-primary);
    }
    .stat-item p {
        margin-bottom: 0;
        font-size: 0.8rem;
        color: var(--text-secondary);
        text-transform: uppercase;
    }
    #project-detail-link-btn {
        width: 100%;
        padding: 0.8rem;
        font-size: 1.1rem;
        font-weight: 600;
        background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
        color: white;
        border: none;
        border-radius: 0.75rem;
        transition: var(--transition-smooth);
    }
    #project-detail-link-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(145, 94, 255, 0.4);
    }
    #project-detail-long-description {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.75rem;
        color: var(--text-primary);
        font-size: 0.95rem;
        line-height: 1.6;
        word-wrap: break-word;
    }
    .embedded-link {
        color: var(--accent-primary);
        font-weight: 500;
        text-decoration: none;
        word-break: break-all;
    }
    .embedded-link:hover {
        text-decoration: underline;
    }
    #project-detail-share-btn {
        background: none;
        border: none;
        font-size: 1.2rem;
        color: var(--text-secondary);
        transition: color 0.3s;
    }
    #project-detail-share-btn:hover {
        color: var(--accent-primary);
    }

    /* === NEW STYLES for NEW FEATURES === */
    /* Profile View Counter */
    .profile-stats {
        margin-top: 1rem;
        color: rgba(255, 255, 255, 0.8);
    }
    .profile-stats i {
        margin-right: 6px;
    }

    /* Search Bar */
    .search-container {
        margin-top: 2rem;
        margin-bottom: -1rem;
    }
    #project-search-input {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        border-radius: 12px;
    }
    #project-search-input::placeholder { color: rgba(255, 255, 255, 0.6); }

    /* YouTube Embed */
    .youtube-embed-container {
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 9; /* Responsive 16:9 ratio */
        border-radius: 15px;
        overflow: hidden;
        box-shadow: var(--shadow-light);
    }
    .youtube-embed-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 0;
    }

    /* Dashboard Styling */
    #view-dashboard .card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
    }
    .stat-card {
        border-radius: 1rem;
        padding: 1.5rem;
    }
    .stat-card .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--accent-primary);
    }
    .stat-card .stat-label {
        font-size: 1rem;
        color: var(--text-secondary);
    }
    #top-projects-list .list-group-item {
        background: none;
    }

    /* Preview Mode */
    body.preview-mode #edit-profile-btn,
    body.preview-mode .rename-category-btn,
    body.preview-mode #add-category-btn {
        display: none !important;
    }
    
    /* SortableJS helper class */
    .sortable-ghost {
        opacity: 0.4;
        background: #c8ebfb;
    }

</style>
<body>
    <div id="particles-js"></div>
    <!-- Header Controls -->
    <div class="header-controls" id="header-controls"></div>

    <!-- Sidebar Navigation -->
    <div class="sidebar" id="sidebar">
        <h3 class="sidebar-header">Bmass Profiles</h3>
        <div id="sidebar-links"></div>
    </div>
    <div class="overlay" id="overlay"></div>

    <main class="main-container" id="app-container">
        
        <input type="file" id="import-json-input" accept=".json" style="display: none;" />

        <!-- Email Verification Banner -->
        <div id="email-verification-banner" class="alert alert-warning rounded-3 m-3" style="display: none;">
            Email c·ªßa b·∫°n ch∆∞a ƒë∆∞·ª£c x√°c th·ª±c. Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞ ƒë·∫øn. 
            <button id="resend-verification-btn" class="btn btn-sm btn-primary ms-2">G·ª≠i l·∫°i email</button>
        </div>

        <!-- Loading View -->
        <div class="view text-center" id="view-loading">
            <div class="spinner-border" style="width: 3rem; height: 3rem; color: white;"></div>
        </div>

        <!-- Auth View with Flip Card -->
        <div class="view view-center-content" id="view-auth">
            <div class="flip-card" id="auth-flip-card">
                <div class="flip-card-inner">
                    <!-- Login Form (Front) -->
                    <div class="flip-card-front">
                        <div class="auth-header">
                            <h2>Ch√†o m·ª´ng tr·ªü l·∫°i!</h2>
                            <p class="mb-0">ƒêƒÉng nh·∫≠p ƒë·ªÉ ti·∫øp t·ª•c h√†nh tr√¨nh</p>
                        </div>
                        <div class="auth-body">
                            <form id="login-form">
                                <div class="mb-3"><input type="email" class="form-control" id="login-email" placeholder="Email" required></div>
                                <div class="mb-3"><input type="password" class="form-control" id="login-password" placeholder="M·∫≠t kh·∫©u" required></div>
                                <div class="d-flex justify-content-end mb-3">
                                    <button type="button" class="forgot-password-link" id="forgot-password-btn">Qu√™n m·∫≠t kh·∫©u?</button>
                                </div>
                                <div class="d-grid"><button type="submit" class="btn-submit-grad">ƒêƒÉng nh·∫≠p</button></div>
                            </form>
                            <div class="divider">HO·∫∂C</div>
                            <div class="d-grid">
                                <button class="btn btn-light btn-google" id="google-login-btn">
                                    <img src="https://www.google.com/favicon.ico" alt="Google icon" width="20" height="20" class="me-2"> ƒêƒÉng nh·∫≠p v·ªõi Google
                                </button>
                            </div>
                            <p class="mt-4 text-center text-white-50">
                                Ch∆∞a c√≥ t√†i kho·∫£n? <button class="auth-switch-link" id="show-register-btn">ƒêƒÉng k√Ω ngay</button>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Register Form (Back) -->
                    <div class="flip-card-back">
                         <div class="auth-header">
                            <h2>T·∫°o t√†i kho·∫£n m·ªõi</h2>
                            <p class="mb-0">B·∫Øt ƒë·∫ßu h√†nh tr√¨nh c·ªßa b·∫°n c√πng ch√∫ng t√¥i</p>
                        </div>
                        <div class="auth-body">
                            <form id="register-form">
                                <div class="mb-3"><input type="text" class="form-control" id="register-username" placeholder="Username (a-z, 0-9, _)" required pattern="[a-zA-Z0-9_]{3,20}"></div>
                                <div class="mb-3"><input type="email" class="form-control" id="register-email" placeholder="Email" required></div>
                                <div class="mb-3"><input type="tel" class="form-control" id="register-phone" placeholder="S·ªë ƒëi·ªán tho·∫°i (Kh√¥ng b·∫Øt bu·ªôc)"></div>
                                <div class="mb-3"><input type="password" class="form-control" id="register-password" placeholder="M·∫≠t kh·∫©u (t·ªëi thi·ªÉu 6 k√Ω t·ª±)" required minlength="6"></div>
                                <div class="d-grid mt-4"><button type="submit" class="btn-submit-grad">ƒêƒÉng k√Ω</button></div>
                            </form>
                            <p class="mt-4 text-center text-white-50">
                                ƒê√£ c√≥ t√†i kho·∫£n? <button class="auth-switch-link" id="show-login-btn">ƒêƒÉng nh·∫≠p</button>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div id="auth-status" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100"></div>
        </div>

        <!-- Forgot Password View -->
        <div class="view view-center-content" id="view-forgot-password">
            <div class="card-glass" style="width: 100%; max-width: 420px;">
                 <div class="auth-header" style="border-radius: 20px 20px 0 0; margin: -2rem -2rem 0 -2rem;">
                    <h2>ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u</h2>
                    <p class="mb-0">Ch·ªçn ph∆∞∆°ng th·ª©c ƒë·ªÉ nh·∫≠n li√™n k·∫øt</p>
                </div>
                <div class="auth-body">
                    <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mb-4">
                        <button type="button" id="reset-mode-email-btn" class="btn btn-primary">
                            <i class="fas fa-envelope me-2"></i>S·ª≠ d·ª•ng Email
                        </button>
                        <button type="button" id="reset-mode-phone-btn" class="btn btn-outline-light">
                             <i class="fas fa-phone me-2"></i>S·ª≠ d·ª•ng SƒêT
                        </button>
                    </div>

                    <form id="forgot-password-form">
                        <div id="reset-email-group">
                             <label class="form-label text-white-50">Email ƒë√£ ƒëƒÉng k√Ω</label>
                            <input type="email" class="form-control" id="reset-email-input" placeholder="Email c·ªßa b·∫°n">
                        </div>
                        <div id="reset-phone-group" style="display: none;">
                            <label class="form-label text-white-50">S·ªë ƒëi·ªán tho·∫°i ƒë√£ ƒëƒÉng k√Ω</label>
                            <input type="tel" class="form-control" id="reset-phone-input" placeholder="S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n">
                        </div>
                        <div class="d-grid mt-4">
                            <button type="submit" class="btn-submit-grad">G·ª≠i li√™n k·∫øt</button>
                        </div>
                    </form>
                    <p class="mt-4 text-center text-white-50">
                        <button class="auth-switch-link" id="back-to-login-btn">Quay l·∫°i ƒêƒÉng nh·∫≠p</button>
                    </p>
                </div>
            </div>
        </div>


        <!-- Profile View -->
        <div class="view" id="view-profile">
            <div class="row justify-content-center">
                <div class="col-12 col-md-10 col-lg-8" id="profile-page-content"></div>
            </div>
        </div>

        <!-- NEW: Dashboard View -->
        <div class="view" id="view-dashboard">
            <div class="row justify-content-center">
                <div class="col-12 col-md-10 col-lg-8" id="dashboard-page-content">
                    <!-- Dashboard content will be rendered here by JS -->
                </div>
            </div>
        </div>


        <!-- Not Found View -->
        <div class="view text-center" id="view-not-found">
            <div class="card-glass p-5">
                <h2>Kh√¥ng t√¨m th·∫•y trang</h2>
                <p>Trang c√° nh√¢n b·∫°n ƒëang t√¨m ki·∫øm kh√¥ng t·ªìn t·∫°i.</p>
                <a href="/" class="btn btn-primary">V·ªÅ trang ch·ªß</a>
            </div>
        </div>
    </main>

    <footer class="text-center footer-section">
        <p class="mb-0">¬© <span id="footer-year"></span> Bmass Profiles. All Rights Reserved.</p>
    </footer>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Ch·ªânh s·ª≠a trang c√° nh√¢n</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="edit-modal-body"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" id="save-profile-btn" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">ƒê·ªïi m·∫≠t kh·∫©u</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" id="change-password-modal-body"></div>
                <div class="modal-footer" id="change-password-modal-footer"></div>
            </div>
        </div>
    </div>
    
    <!-- Project Detail Modal -->
    <div class="modal fade" id="projectDetailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" id="project-detail-share-btn" title="Chia s·∫ª d·ª± √°n" data-project-name="" data-project-id="">
                        <i class="fas fa-share-alt"></i>
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="project-detail-header">
                        <img src="" id="project-detail-icon" alt="Project Icon">
                        <div>
                            <h3 id="project-detail-name">Project Name</h3>
                            <span id="project-detail-category">Category</span>
                        </div>
                    </div>
                    <p id="project-detail-description">Project description goes here...</p>
                    
                    <div id="project-detail-long-description-container" style="display: none;">
                         <hr>
                         <h6 class="mb-2">Chi ti·∫øt</h6>
                         <div id="project-detail-long-description"></div>
                    </div>

                    <div id="project-detail-stats" class="mt-4">
                        <div class="stat-item">
                            <h6 id="project-detail-clicks">0</h6>
                            <p>L∆∞·ª£t xem</p>
                        </div>
                    </div>
                    <div class="d-grid">
                         <button id="project-detail-link-btn" data-link="" data-project-index="" data-username="">
                            <i class="fas fa-external-link-alt me-2"></i>Truy c·∫≠p
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// No changes to JS libraries, just added SortableJS CDN in <head>
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {

    particlesJS("particles-js", {
        "particles": { "number": { "value": 80, "density": { "enable": true, "value_area": 800 } }, "color": { "value": "#ffffff" }, "shape": { "type": "circle", }, "opacity": { "value": 0.5, "random": false, }, "size": { "value": 3, "random": true, }, "line_linked": { "enable": true, "distance": 150, "color": "#ffffff", "opacity": 0.4, "width": 1 }, "move": { "enable": true, "speed": 6, "direction": "none", "out_mode": "out", } },
        "interactivity": { "detect_on": "canvas", "events": { "onhover": { "enable": true, "mode": "repulse" }, "onclick": { "enable": true, "mode": "push" }, "resize": true }, "modes": { "repulse": { "distance": 200, "duration": 0.4 }, "push": { "particles_nb": 4 }, } },
        "retina_detect": true
    });

  const firebaseConfig = {
    apiKey: "AIzaSyCLCcgaoW9gNYhKk0c0gDWC6i5mKVTN4XE",
    authDomain: "profile-d1214.firebaseapp.com",
    projectId: "profile-d1214",
    storageBucket: "profile-d1214.firebasestorage.app",
    messagingSenderId: "914980131889",
    appId: "1:914980131889:web:72f8da15c42dbee671b110",
    measurementId: "G-C587M69LZW"
  };

    let auth, db, storage;
    let currentUser = null;
    let passwordResetMode = 'email'; 

    const views = { 
        loading: document.getElementById('view-loading'), 
        auth: document.getElementById('view-auth'), 
        profile: document.getElementById('view-profile'), 
        notFound: document.getElementById('view-not-found'),
        forgotPassword: document.getElementById('view-forgot-password'),
        dashboard: document.getElementById('view-dashboard') // NEW
    };
    const headerControls = document.getElementById('header-controls');
    const profilePageContent = document.getElementById('profile-page-content');
    const dashboardPageContent = document.getElementById('dashboard-page-content'); // NEW
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    const changePasswordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
    const projectDetailModal = new bootstrap.Modal(document.getElementById('projectDetailModal'));
    const importJsonInput = document.getElementById('import-json-input'); 

    const socialIcons = { 
        github: 'fa-brands fa-github', x: 'fa-brands fa-xing', ig: 'fa-brands fa-instagram', 
        tele: 'fa-brands fa-telegram', tiktok: 'fa-brands fa-tiktok', youtube: 'fa-brands fa-youtube',
        discord: 'fa-brands fa-discord', zalo: 'fa-solid fa-comment-dots', gmail: 'fa-solid fa-envelope',
        channel: 'fa-solid fa-satellite-dish', website: 'fa-solid fa-globe' 
    };

    const defaultCategories = {
        project: 'D·ª± √°n',
        exchange: 'Exchange',
        airdrop: 'Airdrop'
    };

    const randomProjectImages = [
        'https://images.unsplash.com/photo-1519389950473-47ba0277781c?&auto=format&fit=crop&w=128&q=80',
        'https://images.unsplash.com/photo-1556761175-b413da4b248d?&auto=format&fit=crop&w=128&q=80',
        'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?&auto=format&fit=crop&w=128&q=80',
        'https://images.unsplash.com/photo-1521737604893-d14cc237f11d?&auto=format&fit=crop&w=128&q=80',
        'https://images.unsplash.com/photo-1552664730-d307ca884978?&auto=format&fit=crop&w=128&q=80',
        'https://images.unsplash.com/photo-1499951360447-b19be8fe80f5?&auto=format&fit=crop&w=128&q=80',
        'https://images.unsplash.com/photo-1551434678-e076c223a692?&auto=format&fit=crop&w=128&q=80',
        'https://images.unsplash.com/photo-1542744173-8e7e53415bb0?&auto=format&fit=crop&w=128&q=80'
    ];

    function getRandomProjectImage() {
        const randomIndex = Math.floor(Math.random() * randomProjectImages.length);
        return randomProjectImages[randomIndex];
    }
    
    const sidebar = document.getElementById('sidebar');
    const sidebarLinks = document.getElementById('sidebar-links');
    const overlay = document.getElementById('overlay');

    const authFlipCard = document.getElementById('auth-flip-card');
    const showRegisterBtn = document.getElementById('show-register-btn');
    const showLoginBtn = document.getElementById('show-login-btn');
    const statusEl = document.getElementById('auth-status');
    const verificationBanner = document.getElementById('email-verification-banner');


    function initializeFirebase() {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        storage = firebase.storage();
    }

    function switchView(viewName) {
        Object.values(views).forEach(view => view.style.display = 'none');
        if (views[viewName]) {
            views[viewName].style.display = (views[viewName].classList.contains('view-center-content')) ? 'flex' : 'block';
        }
    }

    function showToast(message, type = 'danger') {
        const toastId = 'toast-' + Date.now();
        const toastHTML = `<div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>`;
        statusEl.insertAdjacentHTML('beforeend', toastHTML);
        const toast = new bootstrap.Toast(document.getElementById(toastId));
        toast.show();
    }

    function setupSidebar() {
        headerControls.innerHTML = `<button class="sidebar-toggle" id="sidebar-toggle-btn"><i class="fas fa-bars"></i></button>`;
        document.getElementById('sidebar-toggle-btn').addEventListener('click', toggleSidebar);

        if (currentUser) {
            let ownerLinks = `
                <a class="sidebar-link" href="#" id="dashboard-btn"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a class="sidebar-link" href="#" id="preview-mode-btn"><i class="fas fa-eye"></i> Ch·∫ø ƒë·ªô xem tr∆∞·ªõc</a>
                <hr>
            `;
            sidebarLinks.innerHTML = `
                <a class="sidebar-link" href="?user=${currentUser.username}"><i class="fas fa-user-circle"></i> Trang c·ªßa t√¥i</a>
                ${ownerLinks}
                <a class="sidebar-link" href="#" id="copy-profile-link-btn"><i class="fas fa-copy"></i> Sao ch√©p Link</a>
                <a class="sidebar-link" href="#" id="change-password-btn"><i class="fas fa-key"></i> ƒê·ªïi m·∫≠t kh·∫©u</a>
                <hr>
                <a class="sidebar-link" href="#" id="export-json-btn"><i class="fas fa-file-export"></i> Xu·∫•t JSON</a>
                <a class="sidebar-link" href="#" id="import-json-btn"><i class="fas fa-file-import"></i> Nh·∫≠p JSON</a>
                <hr>
                <a class="sidebar-link logout" href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a>`;
            
            document.getElementById('dashboard-btn').addEventListener('click', async (e) => { e.preventDefault(); const docSnap = await db.collection('profiles').doc(currentUser.username).get(); if(docSnap.exists) renderDashboard(docSnap.data()); closeSidebar(); });
            document.getElementById('preview-mode-btn').addEventListener('click', (e) => { e.preventDefault(); togglePreviewMode(); });
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('copy-profile-link-btn').addEventListener('click', handleCopyLink);
            document.getElementById('change-password-btn').addEventListener('click', openChangePasswordModal);
            document.getElementById('export-json-btn').addEventListener('click', handleExportJson);
            document.getElementById('import-json-btn').addEventListener('click', () => importJsonInput.click()); 
        } else {
            sidebarLinks.innerHTML = `<a class="sidebar-link" href="#" id="sidebar-login-btn"><i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p</a><a class="sidebar-link" href="#" id="sidebar-register-btn"><i class="fas fa-user-plus"></i> ƒêƒÉng k√Ω</a>`;
            document.getElementById('sidebar-login-btn').addEventListener('click', (e) => { e.preventDefault(); closeSidebar(); history.pushState(null, '', '/'); switchView('auth'); authFlipCard.classList.remove('is-flipped'); });
            document.getElementById('sidebar-register-btn').addEventListener('click', (e) => { e.preventDefault(); closeSidebar(); history.pushState(null, '', '/'); switchView('auth'); authFlipCard.classList.add('is-flipped'); });
        }
        overlay.addEventListener('click', closeSidebar);
    }
    
    function handleCopyLink(e) { e.preventDefault(); const profileUrl = `${window.location.origin}${window.location.pathname}?user=${currentUser.username}`; navigator.clipboard.writeText(profileUrl).then(() => { showToast("Link ƒë√£ ƒë∆∞·ª£c sao ch√©p!", "success"); closeSidebar(); }); }
    function toggleSidebar() { sidebar.classList.toggle('open'); overlay.classList.toggle('show'); }
    function closeSidebar() { sidebar.classList.remove('open'); overlay.classList.remove('show'); }
    
    async function handleExportJson(e) { e.preventDefault(); if (!currentUser) return; try { const docSnap = await db.collection('profiles').doc(currentUser.username).get(); if (!docSnap.exists) { showToast("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ªì s∆°."); return; } const data = docSnap.data(); const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", `bmass_profile_${currentUser.username}.json`); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); showToast("ƒê√£ xu·∫•t d·ªØ li·ªáu th√†nh c√¥ng!", "success"); closeSidebar(); } catch (error) { console.error("L·ªói khi xu·∫•t JSON:", error); showToast("ƒê√£ c√≥ l·ªói x·∫£y ra khi xu·∫•t d·ªØ li·ªáu."); } }
    async function handleImportJson(e) { const file = e.target.files[0]; if (!file) return; if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën nh·∫≠p d·ªØ li·ªáu t·ª´ t·ªáp n√†y kh√¥ng? M·ªçi d·ªØ li·ªáu h·ªì s∆° hi·ªán t·∫°i (ngo·∫°i tr·ª´ username, email) s·∫Ω b·ªã ghi ƒë√®.")) return; const reader = new FileReader(); reader.onload = async (event) => { try { const importedData = JSON.parse(event.target.result); if (typeof importedData !== 'object' || importedData === null || !importedData.name) throw new Error("T·ªáp JSON kh√¥ng h·ª£p l·ªá."); delete importedData.ownerUid; delete importedData.username; delete importedData.email; await db.collection('profiles').doc(currentUser.username).update(importedData); showToast("Nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng! Trang s·∫Ω ƒë∆∞·ª£c l√†m m·ªõi.", "success"); setTimeout(() => location.reload(), 1500); } catch (error) { console.error("L·ªói khi nh·∫≠p JSON:", error); showToast("L·ªói: " + error.message); } finally { e.target.value = null; } }; reader.readAsText(file); closeSidebar(); }

    async function handleRouteChange() {
        const params = new URLSearchParams(window.location.search);
        const username = params.get('user');
        const projectIdToShow = params.get('project');

        if (username) {
            const profileData = await fetchAndRenderProfile(username);
            
            if (projectIdToShow && profileData) {
                await showProjectModalById(profileData, projectIdToShow, username);
            }

        } else {
            if (currentUser) {
                history.pushState(null, '', `?user=${currentUser.username}`);
                await fetchAndRenderProfile(currentUser.username);
            } else {
                switchView('auth');
            }
        }
    }

    function getCategoryDisplayName(key, customCategories = {}) {
        if (key === 'leaderboard') return 'B·∫£ng x·∫øp h·∫°ng';
        if (defaultCategories[key]) return defaultCategories[key];
        if (customCategories[key]) return customCategories[key];
        return key.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function generateCategoryKey(name) { return name.trim().toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-'); }
    
    function normalizeUrl(url) {
        if (!url || url.trim() === '') return '';
        let trimmedUrl = url.trim();
        if (!/^(https?:\/\/)/i.test(trimmedUrl)) {
            trimmedUrl = 'https://' + trimmedUrl;
        }
        return trimmedUrl;
    }
    
    function linkify(text) {
        if (!text) return '';
        const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        
        let processedText = text.replace(urlRegex, function(url) {
            let href = url;
            if (!href.startsWith('http')) {
                href = 'https://' + href;
            }
            return `<a href="${href}" target="_blank" rel="noopener noreferrer" class="embedded-link">${url}</a>`;
        });
        
        return processedText.replace(/\n/g, '<br>');
    }
    
    // NEW: Helper to get YouTube video ID from various URL formats
    function getYouTubeId(url) {
        let ID = '';
        url = url.replace(/(>|<)/gi,'').split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/)/);
        if (url[2] !== undefined) {
            ID = url[2].split(/[^0-9a-z_\-]/i);
            ID = ID[0];
        } else {
            ID = url;
        }
        return ID;
    }


    async function fetchAndRenderProfile(username) {
        switchView('loading');
        try {
            const docRef = db.collection('profiles').doc(username);
            const docSnap = await docRef.get();
            
            if (!docSnap.exists) {
                switchView('notFound');
                return null;
            }

            // Increment profile view count. This is async and won't block rendering.
            docRef.update({ profileViews: firebase.firestore.FieldValue.increment(1) });
            
            const data = docSnap.data();
            const isOwner = currentUser && currentUser.uid === data.ownerUid;

            let socialLinksHTML = '';
            for (const [key, url] of Object.entries(data.socials || {})) { if (url && socialIcons[key]) { const href = key === 'gmail' ? `mailto:${url}` : url; socialLinksHTML += `<a href="${href}" ${key !== 'gmail' ? 'target="_blank" rel="noopener noreferrer"' : ''} class="social-link" title="${key}"><i class="${socialIcons[key]}"></i></a>`; } }
            
            const viewCountHTML = `<div class="profile-stats"><i class="fas fa-eye"></i>${(data.profileViews || 0) + 1} L∆∞·ª£t xem</div>`;
            const profileInfoHTML = `<div class="card-glass text-center" style="padding-top: 80px;"><img src="${data.avatarUrl || 'https://via.placeholder.com/150'}" class="profile-avatar"><div class="profile-name-wrapper mt-3"><h1 class="profile-name">${data.name}</h1>${data.isVerified ? '<i class="fas fa-check-circle verified-tick" title="ƒê√£ x√°c th·ª±c"></i>' : ''}</div><p class="text-secondary col-md-10 mx-auto mt-2" style="color: rgba(255, 255, 255, 0.7) !important;">${data.bio}</p>${viewCountHTML}<div class="social-links">${socialLinksHTML}</div>${isOwner ? '<button id="edit-profile-btn" title="Ch·ªânh s·ª≠a"><i class="fas fa-pencil-alt"></i></button>' : ''}</div>`;
            
            const customCategories = data.customCategories || {}; 
            const allProjects = data.projects || [];
            
            let tabsHTML = '';
            let contentHTML = '';

            const leaderboardProjects = [...allProjects]
                .filter(p => p.clicks > 0)
                .sort((a, b) => (b.clicks || 0) - (a.clicks || 0))
                .slice(0, 10);

            if (leaderboardProjects.length > 0) {
                tabsHTML += `<button class="category-tab" data-category="leaderboard"><i class="fas fa-trophy" style="color: #FFD700;"></i><span>B·∫£ng x·∫øp h·∫°ng</span></button>`;
                contentHTML += `<div class="category-content" data-category="leaderboard"><div class="row g-3">${generateProjectItemsHTML(leaderboardProjects, allProjects)}</div></div>`;
            }

            const allCategoryKeys = [...new Set([...Object.keys(defaultCategories), ...Object.keys(customCategories)])];

            allCategoryKeys.forEach(key => {
                const displayName = getCategoryDisplayName(key, customCategories);
                const isCustom = !defaultCategories.hasOwnProperty(key);
                const renameButton = isOwner && isCustom ? `<button class="rename-category-btn" data-category-key="${key}" title="ƒê·ªïi t√™n danh m·ª•c"><i class="fas fa-pencil-alt"></i></button>` : '';
                tabsHTML += `<button class="category-tab" data-category="${key}"><span>${displayName}</span>${renameButton}</button>`;
                
                const projectsInCategory = allProjects.filter(p => (p.category || 'project') === key);
                let itemsHTML = '<p class="text-white-50">Ch∆∞a c√≥ m·ª•c n√†o trong danh m·ª•c n√†y.</p>';
                if(projectsInCategory.length > 0) {
                    itemsHTML = generateProjectItemsHTML(projectsInCategory, allProjects);
                }
                contentHTML += `<div class="category-content" data-category="${key}"><div class="row g-3">${itemsHTML}</div></div>`;
            });
            
            const searchBarHTML = `<div class="search-container"><input type="search" id="project-search-input" class="form-control" placeholder="üîç T√¨m ki·∫øm d·ª± √°n..."></div>`;
            const projectsContainerHTML = allProjects.length > 0 || isOwner ? `${searchBarHTML}<div class="category-tabs-container"><div class="category-tabs" id="category-tabs">${tabsHTML}${isOwner ? '<button class="category-tab" id="add-category-btn" title="Th√™m danh m·ª•c m·ªõi"><i class="fas fa-plus"></i></button>' : ''}<div class="tab-underline" id="tab-underline"></div></div><div class="category-content-container" id="category-content-container">${contentHTML}</div></div>` : '';

            profilePageContent.innerHTML = profileInfoHTML + projectsContainerHTML;
            switchView('profile');

            if (document.getElementById('category-tabs')) {
                setupCategoryTabs();
                document.getElementById('project-search-input').addEventListener('input', handleProjectSearch);
            }
            if (isOwner) {
                const editBtn = document.getElementById('edit-profile-btn');
                if (editBtn) {
                    editBtn.style.display = 'flex';
                    editBtn.addEventListener('click', openEditModal);
                }
                const addCategoryBtn = document.getElementById('add-category-btn');
                if (addCategoryBtn) addCategoryBtn.addEventListener('click', () => handleAddCategory());
            }

            document.querySelectorAll('.project-card').forEach(card => {
                card.addEventListener('click', () => handleProjectClick(card));
            });
            
            return data;
        } catch (error) {
            console.error("Error loading profile:", error);
            switchView('notFound');
            return null;
        }
    }
    
    // NEW: Refactored project item HTML generation
    function generateProjectItemsHTML(projectsToDisplay, allProjectsList) {
        return projectsToDisplay.map(p => {
            const projectIndex = allProjectsList.indexOf(p);
            
            if (p.embedType === 'youtube') {
                const videoId = getYouTubeId(p.link);
                if (videoId) {
                    return `<div class="col-12 col-md-6 mb-3 project-item" data-name="${p.name.toLowerCase()}" data-description="${(p.description || '').toLowerCase()}">
                        <div class="youtube-embed-container">
                            <iframe src="https://www.youtube.com/embed/${videoId}" title="${p.name}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        </div>
                    </div>`;
                }
            }

            // Default card
            return `<div class="col-12 col-md-6 mb-3 project-item" data-name="${p.name.toLowerCase()}" data-description="${(p.description || '').toLowerCase()}">
                <div data-project-index="${projectIndex}" class="project-card h-100">
                    <img src="${p.imageUrl || getRandomProjectImage()}" class="project-icon" alt="${p.name}">
                    <div class="project-card-content">
                        <div class="text-start">
                            <h5>${p.name}</h5>
                            <p class="mb-0">${p.description || ''}</p>
                        </div>
                        <div class="project-clicks">
                            <i class="fas fa-eye me-1"></i>
                            <span class="project-clicks-count">${p.clicks || 0}</span>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    // NEW: Search functionality
    function handleProjectSearch(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        document.querySelectorAll('.project-item').forEach(item => {
            const name = item.dataset.name;
            const desc = item.dataset.description;
            if (name.includes(searchTerm) || desc.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }


    function setupCategoryTabs() {
        const tabsContainer = document.getElementById('category-tabs');
        const underline = document.getElementById('tab-underline');
        const contentContainer = document.getElementById('category-content-container');
        const tabs = tabsContainer.querySelectorAll('.category-tab:not(#add-category-btn)');
        const contents = contentContainer.querySelectorAll('.category-content');

        if (tabs.length === 0) return;

        function updateUnderline(activeTab) { if (!activeTab) return; requestAnimationFrame(() => { const offsetLeft = activeTab.offsetLeft; const offsetWidth = activeTab.offsetWidth; underline.style.transform = `translateX(${offsetLeft}px)`; underline.style.width = `${offsetWidth}px`; }); }
        
        function switchTab(targetTab) {
            const category = targetTab.dataset.category;
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            targetTab.classList.add('active');
            const activeContent = contentContainer.querySelector(`.category-content[data-category="${category}"]`);
            if (activeContent) activeContent.classList.add('active');
            updateUnderline(targetTab);
        }

        tabsContainer.addEventListener('click', (e) => {
            const targetTab = e.target.closest('.category-tab:not(#add-category-btn)');
            const renameBtn = e.target.closest('.rename-category-btn');
            if (renameBtn) {
                e.stopPropagation(); 
                handleRenameCategory(renameBtn.dataset.categoryKey);
            } else if (targetTab) {
                switchTab(targetTab);
            }
        });
        
        if (tabs[0]) switchTab(tabs[0]); 
    }

    async function handleProjectClick(cardElement) {
        const projectIndex = parseInt(cardElement.dataset.projectIndex, 10);
        const username = new URLSearchParams(window.location.search).get('user');

        if (isNaN(projectIndex) || !username) return;

        try {
            const docSnap = await db.collection('profiles').doc(username).get();
            if (!docSnap.exists) return;

            const data = docSnap.data();
            const project = (data.projects || [])[projectIndex];
            const customCategories = data.customCategories || {};

            if (project) {
                document.getElementById('project-detail-icon').src = project.imageUrl || getRandomProjectImage();
                document.getElementById('project-detail-name').textContent = project.name;
                document.getElementById('project-detail-description').textContent = project.description || 'Kh√¥ng c√≥ m√¥ t·∫£.';
                document.getElementById('project-detail-category').textContent = getCategoryDisplayName(project.category || 'project', customCategories);
                document.getElementById('project-detail-clicks').textContent = project.clicks || 0;

                const longDescContainer = document.getElementById('project-detail-long-description-container');
                const longDescElement = document.getElementById('project-detail-long-description');
                if (project.longDescription && project.longDescription.trim() !== '') {
                    longDescElement.innerHTML = linkify(project.longDescription);
                    longDescContainer.style.display = 'block';
                } else {
                    longDescContainer.style.display = 'none';
                    longDescElement.innerHTML = '';
                }

                const linkBtn = document.getElementById('project-detail-link-btn');
                linkBtn.dataset.link = project.link;
                linkBtn.dataset.projectIndex = projectIndex;
                linkBtn.dataset.username = username;
                
                const shareBtn = document.getElementById('project-detail-share-btn');
                shareBtn.dataset.projectName = project.name;
                shareBtn.dataset.projectId = project.id; 

                projectDetailModal.show();
            }
        } catch (error) {
            console.error("Error fetching project details:", error);
            showToast("Kh√¥ng th·ªÉ t·∫£i th√¥ng tin d·ª± √°n.");
        }
    }
    
    async function handleShareProject(buttonElement) {
        const name = buttonElement.dataset.projectName;
        const projectId = buttonElement.dataset.projectId;
        const username = new URLSearchParams(window.location.search).get('user');
        
        if (!name || !projectId || !username) return;

        const shareUrl = `${window.location.origin}${window.location.pathname}?user=${username}&project=${projectId}`;

        if (navigator.share) {
            try {
                await navigator.share({
                    title: `Check out: ${name}`,
                    text: `Xem d·ª± √°n "${name}" tr√™n trang c·ªßa ${username}!`,
                    url: shareUrl,
                });
            } catch (error) {
                console.error('Error sharing:', error);
            }
        } else {
            navigator.clipboard.writeText(shareUrl).then(() => {
                showToast("Link d·ª± √°n ƒë√£ ƒë∆∞·ª£c sao ch√©p!", "success");
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast("Kh√¥ng th·ªÉ sao ch√©p link.");
            });
        }
    }
    
    async function showProjectModalById(profileData, projectId, username) {
        const allProjects = profileData.projects || [];
        const projectToShow = allProjects.find(p => p.id == projectId); 

        if (projectToShow) {
            const projectIndex = allProjects.indexOf(projectToShow);
            const cardElement = { dataset: { projectIndex: projectIndex } };
            await handleProjectClick(cardElement);
            const cleanUrl = `${window.location.pathname}?user=${username}`;
            history.replaceState(null, '', cleanUrl);
        } else {
            showToast("Kh√¥ng t√¨m th·∫•y d·ª± √°n v·ªõi ID n√†y.");
        }
    }


    async function handleProjectLinkActivation(buttonElement) {
        const link = buttonElement.dataset.link;
        const projectIndex = parseInt(buttonElement.dataset.projectIndex, 10);
        const username = buttonElement.dataset.username;

        if (!link || isNaN(projectIndex) || !username) return;

        window.open(link, '_blank', 'noopener,noreferrer');

        try {
            const docRef = db.collection('profiles').doc(username);
            const docSnap = await docRef.get();
            if (!docSnap.exists) return;

            const data = docSnap.data();
            let projects = data.projects || [];

            if (projects[projectIndex]) {
                const currentClicks = projects[projectIndex].clicks || 0;
                projects[projectIndex].clicks = currentClicks + 1;
                
                await docRef.update({ projects: projects });

                const clicksElementOnCard = document.querySelector(`.project-card[data-project-index="${projectIndex}"] .project-clicks-count`);
                const clicksElementInModal = document.getElementById('project-detail-clicks');
                
                if (clicksElementOnCard) {
                    clicksElementOnCard.textContent = projects[projectIndex].clicks;
                }
                if (clicksElementInModal) {
                    clicksElementInModal.textContent = projects[projectIndex].clicks;
                }
            }
        } catch (error) {
            console.error("Failed to update click count:", error);
        }
    }

    async function handleAddCategory(fromModal = false) {
        const categoryName = prompt("Nh·∫≠p t√™n danh m·ª•c m·ªõi:");
        if (!categoryName || categoryName.trim() === '') return;

        const categoryKey = generateCategoryKey(categoryName);
        if (!categoryKey) {
            showToast("T√™n danh m·ª•c kh√¥ng h·ª£p l·ªá.");
            return;
        }

        try {
            const docRef = db.collection('profiles').doc(currentUser.username);
            const docSnap = await docRef.get();
            const data = docSnap.data();
            const customCategories = data.customCategories || {};

            if (defaultCategories.hasOwnProperty(categoryKey) || customCategories.hasOwnProperty(categoryKey)) {
                showToast("Danh m·ª•c n√†y ƒë√£ t·ªìn t·∫°i.");
                return;
            }
            
            const updateData = {};
            updateData[`customCategories.${categoryKey}`] = categoryName.trim();

            await docRef.update(updateData);
            showToast("ƒê√£ th√™m danh m·ª•c m·ªõi!", "success");
            
            if (fromModal) {
                editModal.hide();
            }
            fetchAndRenderProfile(currentUser.username);
        } catch (error) {
            console.error("L·ªói khi th√™m danh m·ª•c:", error);
            showToast("Kh√¥ng th·ªÉ th√™m danh m·ª•c.");
        }
    }
    
    async function handleRenameCategory(oldKey, fromModal = false) {
        try {
            const docRef = db.collection('profiles').doc(currentUser.username);
            const docSnap = await docRef.get();
            if (!docSnap.exists) return;
            const data = docSnap.data();
            const customCategories = data.customCategories || {};
            const projects = data.projects || [];

            const oldDisplayName = customCategories[oldKey] || oldKey;
            const newName = prompt("ƒê·ªïi t√™n danh m·ª•c:", oldDisplayName);

            if (!newName || newName.trim() === '' || newName.trim() === oldDisplayName) return;

            const newKey = generateCategoryKey(newName);
            if (!newKey) {
                showToast("T√™n danh m·ª•c m·ªõi kh√¥ng h·ª£p l·ªá.");
                return;
            }

            if (newKey !== oldKey && (defaultCategories.hasOwnProperty(newKey) || customCategories.hasOwnProperty(newKey))) {
                showToast("T√™n danh m·ª•c n√†y ƒë√£ t·ªìn t·∫°i.");
                return;
            }
            
            delete customCategories[oldKey];
            customCategories[newKey] = newName.trim();

            const updatedProjects = projects.map(proj => {
                if (proj.category === oldKey) {
                    return { ...proj, category: newKey };
                }
                return proj;
            });

            await docRef.update({
                customCategories: customCategories,
                projects: updatedProjects
            });

            showToast("ƒê·ªïi t√™n danh m·ª•c th√†nh c√¥ng!", "success");
            
            if (fromModal) {
                editModal.hide();
            }
            fetchAndRenderProfile(currentUser.username);
        } catch (error) {
            console.error("L·ªói khi ƒë·ªïi t√™n danh m·ª•c:", error);
            showToast("Kh√¥ng th·ªÉ ƒë·ªïi t√™n danh m·ª•c.");
        }
    }

    async function handleDeleteCategory(keyToDelete) {
        try {
            const docRef = db.collection('profiles').doc(currentUser.username);
            const docSnap = await docRef.get();
            if (!docSnap.exists) return;

            const data = docSnap.data();
            const customCategories = data.customCategories || {};
            const projects = data.projects || [];
            const displayName = customCategories[keyToDelete] || keyToDelete;
            
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a danh m·ª•c "${displayName}" kh√¥ng?\nT·∫•t c·∫£ c√°c m·ª•c trong danh m·ª•c n√†y s·∫Ω ƒë∆∞·ª£c chuy·ªÉn v·ªÅ "D·ª± √°n".`)) {
                return;
            }

            delete customCategories[keyToDelete];

            const updatedProjects = projects.map(proj => {
                if (proj.category === keyToDelete) {
                    return { ...proj, category: 'project' }; 
                }
                return proj;
            });
            
            await docRef.update({
                customCategories: customCategories,
                projects: updatedProjects
            });

            showToast("ƒê√£ x√≥a danh m·ª•c th√†nh c√¥ng!", "success");
            editModal.hide();
            fetchAndRenderProfile(currentUser.username);

        } catch (error) {
            console.error("L·ªói khi x√≥a danh m·ª•c:", error);
            showToast("Kh√¥ng th·ªÉ x√≥a danh m·ª•c.");
        }
    }


    async function handleRegister(e) { e.preventDefault(); const username = document.getElementById('register-username').value.trim().toLowerCase(); const email = document.getElementById('register-email').value.trim(); const password = document.getElementById('register-password').value; const phone = document.getElementById('register-phone').value.trim(); const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true; btn.innerHTML = `<div class="spinner-border spinner-border-sm"></div>`; if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) { showToast("Username kh√¥ng h·ª£p l·ªá."); btn.disabled = false; btn.textContent = 'ƒêƒÉng k√Ω'; return; } if (phone && phone.length < 9) { showToast("S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá."); btn.disabled = false; btn.textContent = 'ƒêƒÉng k√Ω'; return; } try { const userDoc = await db.collection('profiles').doc(username).get(); if (userDoc.exists) { showToast("Username n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng."); btn.disabled = false; btn.textContent = 'ƒêƒÉng k√Ω'; return; } const userCredential = await auth.createUserWithEmailAndPassword(email, password); const user = userCredential.user; await user.sendEmailVerification(); await db.collection('profiles').doc(username).set({ ownerUid: user.uid, username, name: username, avatarUrl: "", isVerified: false, email, phoneNumber: phone, bio: "Ch√†o m·ª´ng ƒë·∫øn trang c·ªßa t√¥i!", socials: {}, projects: [], customCategories: {}, profileViews: 0 }); showToast("ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng x√°c th·ª±c email.", 'success'); currentUser = { uid: user.uid, email: user.email, username, providerId: 'password' }; setupSidebar(); history.pushState(null, '', `?user=${username}`); verificationBanner.style.display = 'block'; await fetchAndRenderProfile(username); } catch (error) { showToast(error.code === 'auth/email-already-in-use' ? "Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng." : "ƒê√£ c√≥ l·ªói x·∫£y ra."); } finally { btn.disabled = false; btn.textContent = 'ƒêƒÉng k√Ω'; } }
    async function handleLogin(e) { e.preventDefault(); const email = document.getElementById('login-email').value.trim(); const password = document.getElementById('login-password').value; const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true; btn.innerHTML = `<div class="spinner-border spinner-border-sm"></div>`; try { await auth.signInWithEmailAndPassword(email, password); } catch (error) { showToast("Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c."); btn.disabled = false; btn.textContent = 'ƒêƒÉng nh·∫≠p'; } }
    async function handleLogout(e) { e.preventDefault(); await auth.signOut(); window.location.href = '/'; }
    async function handleGoogleLogin() { const provider = new firebase.auth.GoogleAuthProvider(); try { const result = await auth.signInWithPopup(provider); const user = result.user; const profileQuery = await db.collection('profiles').where('ownerUid', '==', user.uid).limit(1).get(); if (profileQuery.empty) { let username = user.email.split('@')[0].replace(/[^a-zA-Z0-9_]/g, ''); let userDoc = await db.collection('profiles').doc(username).get(); while(userDoc.exists) { username = username + Math.floor(Math.random() * 100); userDoc = await db.collection('profiles').doc(username).get(); } await db.collection('profiles').doc(username).set({ ownerUid: user.uid, username, name: user.displayName || username, avatarUrl: user.photoURL || "", isVerified: true, email: user.email, phoneNumber: "", bio: "Ch√†o m·ª´ng ƒë·∫øn trang c·ªßa t√¥i!", socials: {}, projects: [], customCategories: {}, profileViews: 0 }); currentUser = { uid: user.uid, email: user.email, username, providerId: 'google.com' }; setupSidebar(); history.pushState(null, '', `?user=${username}`); await fetchAndRenderProfile(username); showToast("T√†i kho·∫£n ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!", 'success'); } else { showToast("Ch√†o m·ª´ng b·∫°n tr·ªü l·∫°i!", 'success'); } } catch (error) { if (error.code !== 'auth/popup-closed-by-user') showToast("Kh√¥ng th·ªÉ ƒëƒÉng nh·∫≠p v·ªõi Google."); } }
    async function handleForgotPassword(e) { e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); btn.disabled = true; btn.innerHTML = `<div class="spinner-border spinner-border-sm"></div> ƒêang g·ª≠i...`; try { if (passwordResetMode === 'email') { const email = document.getElementById('reset-email-input').value.trim(); if (!email) { showToast("Vui l√≤ng nh·∫≠p email."); return; } await auth.sendPasswordResetEmail(email); showToast(`ƒê√£ g·ª≠i email kh√¥i ph·ª•c ƒë·∫øn ${email}.`, 'success'); switchView('auth'); } else { const phone = document.getElementById('reset-phone-input').value.trim(); if (!phone) { showToast("Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i."); return; } const querySnapshot = await db.collection('profiles').where('phoneNumber', '==', phone).limit(1).get(); if (querySnapshot.empty) showToast("Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n v·ªõi s·ªë ƒëi·ªán tho·∫°i n√†y."); else { const userEmail = querySnapshot.docs[0].data().email; if (userEmail) { await auth.sendPasswordResetEmail(userEmail); showToast(`ƒê√£ g·ª≠i li√™n k·∫øt kh√¥i ph·ª•c.`, 'success'); switchView('auth'); } else showToast("T√†i kho·∫£n n√†y kh√¥ng c√≥ email ƒë·ªÉ g·ª≠i li√™n k·∫øt."); } } } catch (error) { showToast("ƒê√£ x·∫£y ra l·ªói."); } finally { btn.disabled = false; btn.textContent = 'G·ª≠i li√™n k·∫øt'; } }
    async function reauthenticateUser() { const user = auth.currentUser; const providerId = user.providerData[0].providerId; if (providerId === 'password') { const password = prompt("ƒê·ªÉ x√°c nh·∫≠n, vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u c·ªßa b·∫°n:"); if (!password) return null; return user.reauthenticateWithCredential(firebase.auth.EmailAuthProvider.credential(user.email, password)); } else if (providerId === 'google.com') { return user.reauthenticateWithPopup(new firebase.auth.GoogleAuthProvider()); } }
    async function handleChangeEmail(e) { const newEmail = document.getElementById('edit-email').value.trim(); if (newEmail === auth.currentUser.email) return; const btn = e.target; btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>'; try { await reauthenticateUser(); await auth.currentUser.verifyBeforeUpdateEmail(newEmail); await db.collection('profiles').doc(currentUser.username).update({ email: newEmail }); showToast(`Email x√°c th·ª±c ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn ${newEmail}.`, 'success'); editModal.hide(); } catch (error) { if (error.code === 'auth/wrong-password') showToast("M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c."); else if (error.code === 'auth/email-already-in-use') showToast("Email n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng."); else if (error.code !== 'auth/popup-closed-by-user') showToast("X√°c th·ª±c th·∫•t b·∫°i."); } finally { btn.disabled = false; btn.textContent = 'ƒê·ªïi'; } }
    async function handleChangeUsername(e) { const newUsername = document.getElementById('edit-username').value.trim().toLowerCase(); if (!newUsername || newUsername === currentUser.username || !/^[a-zA-Z0-9_]{3,20}$/.test(newUsername)) return; const btn = e.target; btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>'; try { const newDoc = await db.collection('profiles').doc(newUsername).get(); if (newDoc.exists) { showToast("Username n√†y ƒë√£ t·ªìn t·∫°i."); return; } await reauthenticateUser(); const oldDoc = await db.collection('profiles').doc(currentUser.username).get(); if (oldDoc.exists) { const profileData = oldDoc.data(); profileData.username = newUsername; await db.collection('profiles').doc(newUsername).set(profileData); await db.collection('profiles').doc(currentUser.username).delete(); currentUser.username = newUsername; history.pushState(null, '', `?user=${newUsername}`); setupSidebar(); editModal.hide(); showToast(`ƒê·ªïi username th√†nh c√¥ng!`, "success"); } } catch (error) { if (error.code === 'auth/wrong-password') showToast("M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c."); else if (error.code !== 'auth/popup-closed-by-user') showToast("X√°c th·ª±c th·∫•t b·∫°i."); } finally { btn.disabled = false; btn.textContent = 'ƒê·ªïi'; } }
    
    async function openEditModal() {
        const modalBody = document.getElementById('edit-modal-body');
        const docSnap = await db.collection('profiles').doc(currentUser.username).get();
        const data = docSnap.data();
        
        const customCategories = data.customCategories || {};
        const allCategoryKeys = [...new Set([...Object.keys(defaultCategories), ...Object.keys(customCategories)])];
        let projectFieldsHTML = (data.projects || []).map((p, i) => createProjectFieldHTML(p, i, allCategoryKeys, customCategories)).join('');
        const socialFieldsHTML = Object.keys(socialIcons).map(key => `<div class="col-md-6 mb-3"><label class="form-label small">${key === 'gmail' ? 'ƒê·ªãa ch·ªâ Gmail' : `${key.charAt(0).toUpperCase() + key.slice(1)} URL`}</label><input type="${key === 'gmail' ? 'email' : 'url'}" class="form-control" id="edit-${key}" value="${(data.socials || {})[key] || ''}"></div>`).join('');

        let categoryManagerHTML = '<hr><h6 class="mb-3">Qu·∫£n l√Ω Danh m·ª•c</h6>';
        categoryManagerHTML += '<div id="category-manager-container" class="border rounded p-2 mb-3">';
        if (Object.keys(customCategories).length > 0) {
            for (const [key, name] of Object.entries(customCategories)) {
                categoryManagerHTML += `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <span class="text-truncate" style="max-width: 60%;">${name}</span>
                        <div class="ms-auto">
                            <button type="button" class="btn btn-sm btn-outline-primary me-2 edit-cat-btn" data-cat-key="${key}" title="S·ª≠a t√™n"><i class="fas fa-pencil-alt"></i></button>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-cat-btn" data-cat-key="${key}" title="X√≥a"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>`;
            }
        } else {
             categoryManagerHTML += '<p class="text-muted text-center small mb-0">B·∫°n ch∆∞a c√≥ danh m·ª•c t√πy ch·ªânh n√†o.</p>';
        }
        categoryManagerHTML += '</div><button type="button" id="add-category-modal-btn" class="btn btn-outline-success btn-sm"><i class="fas fa-plus me-1"></i>Th√™m danh m·ª•c m·ªõi</button>';


        modalBody.innerHTML = `<form id="edit-form">
            <div class="mb-3"><label class="form-label">·∫¢nh ƒë·∫°i di·ªán</label><div class="d-flex align-items-center"><img id="avatar-preview" src="${data.avatarUrl || 'https://via.placeholder.com/150'}" class="rounded-circle me-3" width="80" height="80" style="object-fit: cover; border: 2px solid #ddd;"><div class="flex-grow-1"><input type="file" class="form-control" id="edit-avatar-file" accept="image/*"><input type="hidden" id="edit-avatar-url" value="${data.avatarUrl || ''}"><div class="form-text">Ch·ªçn m·ªôt file ·∫£nh m·ªõi ƒë·ªÉ thay ƒë·ªïi.</div></div></div></div>
            <div class="mb-3"><label class="form-label">T√™n hi·ªÉn th·ªã</label><input type="text" class="form-control" id="edit-name" value="${data.name || ''}" required></div>
            <div class="mb-3"><label class="form-label">Ti·ªÉu s·ª≠ ng·∫Øn</label><textarea class="form-control" id="edit-bio" rows="3">${data.bio || ''}</textarea></div>
            <hr><h6 class="mb-3">T√†i kho·∫£n & B·∫£o m·∫≠t</h6>
            <div class="mb-3"><label class="form-label">Username</label><div class="input-group"><span class="input-group-text d-none d-sm-flex">.../?user=</span><input type="text" class="form-control" id="edit-username" value="${currentUser.username}"><button class="btn btn-outline-danger" type="button" id="change-username-btn">ƒê·ªïi</button></div><div class="form-text text-danger">ƒê·ªïi username s·∫Ω thay ƒë·ªïi ƒë∆∞·ªùng d·∫´n trang c·ªßa b·∫°n.</div></div>
            <div class="row"><div class="col-md-6 mb-3"><label class="form-label">Email</label><div class="input-group"><input type="email" class="form-control" id="edit-email" value="${auth.currentUser.email}" required><button class="btn btn-outline-primary" type="button" id="change-email-btn">ƒê·ªïi</button></div></div><div class="col-md-6 mb-3"><label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label><input type="tel" class="form-control" id="edit-phone" value="${data.phoneNumber || ''}"></div></div>
            <hr><h6 class="mb-3">Li√™n k·∫øt M·∫°ng x√£ h·ªôi</h6><div class="row g-2">${socialFieldsHTML}</div>
            
            ${categoryManagerHTML}

            <hr><h6 class="mb-3">Danh s√°ch Li√™n k·∫øt</h6><div id="edit-projects-container">${projectFieldsHTML}</div><button type="button" id="edit-add-project-btn" class="btn btn-outline-secondary mt-2"><i class="fas fa-plus me-2"></i>Th√™m M·ª•c</button>
        </form>`;

        modalBody.querySelector('#edit-avatar-file').addEventListener('change', e => { if (e.target.files[0]) { const reader = new FileReader(); reader.onload = event => { document.getElementById('avatar-preview').src = event.target.result; }; reader.readAsDataURL(e.target.files[0]); } });
        document.getElementById('edit-add-project-btn').addEventListener('click', () => { document.getElementById('edit-projects-container').insertAdjacentHTML('beforeend', createProjectFieldHTML({}, document.querySelectorAll('.project-field').length, allCategoryKeys, customCategories)); });
        modalBody.querySelector('#change-email-btn').addEventListener('click', handleChangeEmail);
        modalBody.querySelector('#change-username-btn').addEventListener('click', handleChangeUsername);

        const managerContainer = modalBody.querySelector('#category-manager-container');
        if (managerContainer) {
             managerContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-cat-btn');
                const deleteBtn = e.target.closest('.delete-cat-btn');
                if (editBtn) {
                    handleRenameCategory(editBtn.dataset.catKey, true);
                }
                if (deleteBtn) {
                    handleDeleteCategory(deleteBtn.dataset.catKey);
                }
            });
        }
        modalBody.querySelector('#add-category-modal-btn').addEventListener('click', () => handleAddCategory(true));

        // NEW: Initialize SortableJS for drag and drop
        const projectsContainer = document.getElementById('edit-projects-container');
        if (projectsContainer) {
            new Sortable(projectsContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost'
            });
        }


        editModal.show();
    }
    
    function createProjectFieldHTML(project = {}, index, categories, customCategories = {}) {
        const categoryOptions = categories.map(key => {
            const displayName = getCategoryDisplayName(key, customCategories);
            const isSelected = (project.category || 'project') === key;
            return `<option value="${key}" ${isSelected ? 'selected' : ''}>${displayName}</option>`;
        }).join('');
        return `<div class="p-3 border rounded mb-3 project-field">
            <div class="d-flex justify-content-between align-items-center mb-2" style="cursor: grab;">
                <strong>M·ª•c #${index + 1}</strong>
                <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
            <input type="hidden" class="project-id-hidden" value="${project.id || ''}">
            <input type="hidden" class="project-clicks-hidden" value="${project.clicks || 0}">
            <div class="row g-2">
                <div class="col-md-6"><label class="form-label small">T√™n</label><input type="text" class="form-control mb-2 project-name" placeholder="T√™n d·ª± √°n/s√†n" value="${project.name || ''}"></div>
                <div class="col-md-6"><label class="form-label small">Danh m·ª•c</label><select class="form-select project-category">${categoryOptions}</select></div>
            </div>
            <label class="form-label small">M√¥ t·∫£ ng·∫Øn</label><input type="text" class="form-control mb-2 project-desc" placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn" value="${project.description || ''}">
            <div class="row g-2">
                <div class="col-md-8"><label class="form-label small">Link</label><input type="url" class="form-control project-link" placeholder="ƒê∆∞·ªùng d·∫´n (URL)" value="${project.link || ''}"></div>
                <div class="col-md-4"><label class="form-label small">Lo·∫°i</label><select class="form-select project-embed-type"><option value="normal" ${project.embedType !== 'youtube' ? 'selected' : ''}>Link th∆∞·ªùng</option><option value="youtube" ${project.embedType === 'youtube' ? 'selected' : ''}>Nh√∫ng YouTube</option></select></div>
            </div>
            <label class="form-label small mt-2">URL H√¨nh ·∫£nh (b·ªè tr·ªëng n·∫øu nh√∫ng YouTube)</label><input type="url" class="form-control project-image" placeholder="Link ·∫£nh logo" value="${project.imageUrl || ''}">
            <label class="form-label small mt-2">M√¥ t·∫£ d√†i (H∆∞·ªõng d·∫´n, chi ti·∫øt...)</label>
            <textarea class="form-control project-long-desc" rows="4" placeholder="N·ªôi dung chi ti·∫øt s·∫Ω hi·ªÉn th·ªã trong popup...">${project.longDescription || ''}</textarea>
        </div>`;
    }

    function getNewProjectId(projectsArray) {
        if (!projectsArray || projectsArray.length === 0) {
            return 1;
        }
        const maxId = Math.max(...projectsArray.map(p => p.id || 0));
        return maxId + 1;
    }


    async function handleSaveProfile() { 
        const saveBtn = document.getElementById('save-profile-btn'); 
        saveBtn.disabled = true; 
        saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang l∆∞u...`; 
        try { 
            let avatarUrlToSave = document.getElementById('edit-avatar-url').value; 
            const file = document.getElementById('edit-avatar-file').files[0]; 
            if (file) { 
                const filePath = `avatars/${currentUser.uid}/avatar_${Date.now()}`; 
                const fileRef = storage.ref(filePath); 
                await fileRef.put(file); 
                avatarUrlToSave = await fileRef.getDownloadURL(); 
            } 
            const socialsData = {}; 
            Object.keys(socialIcons).forEach(key => { 
                const el = document.getElementById(`edit-${key}`); 
                if (el) socialsData[key] = el.value.trim(); 
            }); 
            
            const projectsData = []; 
            const existingProjects = (await db.collection('profiles').doc(currentUser.username).get()).data().projects || [];

            document.querySelectorAll('#edit-projects-container .project-field').forEach(field => { 
                const name = field.querySelector('.project-name').value.trim(); 
                const link = field.querySelector('.project-link').value.trim(); 
                if (name && link) { 
                    let projectId = parseInt(field.querySelector('.project-id-hidden').value, 10);
                    if (!projectId || isNaN(projectId)) {
                        projectId = getNewProjectId([...existingProjects, ...projectsData]);
                    }

                    projectsData.push({ 
                        id: projectId,
                        name, 
                        description: field.querySelector('.project-desc').value.trim(), 
                        link: normalizeUrl(link),
                        imageUrl: field.querySelector('.project-image').value.trim(), 
                        category: field.querySelector('.project-category').value,
                        clicks: parseInt(field.querySelector('.project-clicks-hidden').value, 10) || 0,
                        longDescription: field.querySelector('.project-long-desc').value.trim(),
                        embedType: field.querySelector('.project-embed-type').value
                    }); 
                } 
            }); 
            
            const updatedProfileData = { 
                name: document.getElementById('edit-name').value.trim(), 
                avatarUrl: avatarUrlToSave, 
                bio: document.getElementById('edit-bio').value.trim(), 
                phoneNumber: document.getElementById('edit-phone').value.trim(), 
                socials: socialsData, 
                projects: projectsData, 
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp() 
            }; 
            
            await db.collection('profiles').doc(currentUser.username).update(updatedProfileData); 
            editModal.hide(); 
            await fetchAndRenderProfile(currentUser.username); 
            showToast("C·∫≠p nh·∫≠t th√†nh c√¥ng!", "success"); 
        } catch (error) { 
            console.error("L·ªói khi l∆∞u profile:", error); 
            showToast("L·ªói khi l∆∞u. Vui l√≤ng th·ª≠ l·∫°i."); 
        } finally { 
            saveBtn.disabled = false; 
            saveBtn.textContent = 'L∆∞u thay ƒë·ªïi'; 
        } 
    }

    function openChangePasswordModal() {
        const modalBody = document.getElementById('change-password-modal-body');
        const modalFooter = document.getElementById('change-password-modal-footer');

        modalBody.innerHTML = `<p>M·ªôt li√™n k·∫øt ƒë·ªÉ ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email ƒë√£ ƒëƒÉng k√Ω c·ªßa b·∫°n:</p><p class="text-center"><strong>${auth.currentUser.email}</strong></p><p>Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞ ƒë·∫øn ƒë·ªÉ ti·∫øp t·ª•c.</p>`;

        modalFooter.innerHTML = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button type="button" id="send-reset-link-btn" class="btn btn-primary">G·ª≠i li√™n k·∫øt</button>
        `;

        document.getElementById('send-reset-link-btn').addEventListener('click', handleSendResetLinkFromModal);

        changePasswordModal.show();
    }

    async function handleSendResetLinkFromModal() {
        const btn = document.getElementById('send-reset-link-btn');
        btn.disabled = true;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> ƒêang g·ª≠i...`;

        try {
            await auth.sendPasswordResetEmail(auth.currentUser.email);
            showToast("Email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c g·ª≠i.", "success");
            changePasswordModal.hide();
        } catch (error) {
            console.error("L·ªói g·ª≠i email ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u:", error);
            showToast("G·ª≠i email th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.");
            btn.disabled = false;
            btn.textContent = 'G·ª≠i li√™n k·∫øt';
        }
    }
    
    // NEW: Dashboard and Preview Mode functions
    function renderDashboard(data) {
        const allProjects = data.projects || [];
        const totalClicks = allProjects.reduce((sum, p) => sum + (p.clicks || 0), 0);
        const topProjects = [...allProjects].sort((a, b) => (b.clicks || 0) - (a.clicks || 0)).slice(0, 5);
        
        const topProjectsHTML = topProjects.map((p, index) => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span><strong>#${index + 1}</strong> ${p.name}</span>
                <span class="badge bg-primary rounded-pill">${p.clicks || 0} clicks</span>
            </li>
        `).join('') || '<li class="list-group-item">Ch∆∞a c√≥ d·ªØ li·ªáu.</li>';

        dashboardPageContent.innerHTML = `
            <div class="card-glass text-white mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">Dashboard</h2>
                    <button id="back-to-profile-btn" class="btn btn-outline-light">V·ªÅ trang c√° nh√¢n</button>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card stat-card text-center h-100">
                        <div class="stat-value">${data.profileViews || 0}</div>
                        <div class="stat-label">T·ªïng l∆∞·ª£t xem trang</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card stat-card text-center h-100">
                        <div class="stat-value">${totalClicks}</div>
                        <div class="stat-label">T·ªïng l∆∞·ª£t nh·∫•p d·ª± √°n</div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card stat-card">
                        <h5 class="mb-3">Top 5 d·ª± √°n h√†ng ƒë·∫ßu</h5>
                        <ul class="list-group list-group-flush" id="top-projects-list">
                           ${topProjectsHTML}
                        </ul>
                    </div>
                </div>
            </div>
        `;
        document.getElementById('back-to-profile-btn').addEventListener('click', () => switchView('profile'));
        switchView('dashboard');
    }

    function togglePreviewMode() {
        document.body.classList.toggle('preview-mode');
        const btn = document.getElementById('preview-mode-btn');
        const isPreviewing = document.body.classList.contains('preview-mode');
        btn.innerHTML = isPreviewing ? '<i class="fas fa-edit"></i> T·∫Øt xem tr∆∞·ªõc' : '<i class="fas fa-eye"></i> Ch·∫ø ƒë·ªô xem tr∆∞·ªõc';
        showToast(isPreviewing ? "ƒê√£ b·∫≠t ch·∫ø ƒë·ªô xem tr∆∞·ªõc." : "ƒê√£ t·∫Øt ch·∫ø ƒë·ªô xem tr∆∞·ªõc.", "info");
        closeSidebar();
    }


    function setupAuthForm() { showRegisterBtn.addEventListener('click', () => authFlipCard.classList.add('is-flipped')); showLoginBtn.addEventListener('click', () => authFlipCard.classList.remove('is-flipped')); document.getElementById('forgot-password-btn').addEventListener('click', () => switchView('forgotPassword')); document.getElementById('back-to-login-btn').addEventListener('click', () => { switchView('auth'); authFlipCard.classList.remove('is-flipped'); }); const resetEmailBtn = document.getElementById('reset-mode-email-btn'), resetPhoneBtn = document.getElementById('reset-mode-phone-btn'); const resetEmailGroup = document.getElementById('reset-email-group'), resetPhoneGroup = document.getElementById('reset-phone-group'); resetEmailBtn.addEventListener('click', () => { passwordResetMode = 'email'; resetEmailGroup.style.display = 'block'; resetPhoneGroup.style.display = 'none'; resetEmailBtn.classList.replace('btn-outline-light', 'btn-primary'); resetPhoneBtn.classList.replace('btn-primary', 'btn-outline-light'); }); resetPhoneBtn.addEventListener('click', () => { passwordResetMode = 'phone'; resetEmailGroup.style.display = 'none'; resetPhoneGroup.style.display = 'block'; resetPhoneBtn.classList.replace('btn-outline-light', 'btn-primary'); resetEmailBtn.classList.replace('btn-primary', 'btn-outline-light'); }); }

    function main() {
        initializeFirebase();
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                await user.reload(); const refreshedUser = auth.currentUser;
                if (!refreshedUser.emailVerified && refreshedUser.providerData.some(p => p.providerId === 'password')) verificationBanner.style.display = 'block'; else verificationBanner.style.display = 'none';
                const profileQuery = await db.collection('profiles').where('ownerUid', '==', refreshedUser.uid).limit(1).get();
                if (!profileQuery.empty) {
                    const profileData = profileQuery.docs[0].data();
                    currentUser = { uid: refreshedUser.uid, email: refreshedUser.email, username: profileData.username, providerId: refreshedUser.providerData[0].providerId };
                } else { console.warn("User in Auth but not Firestore. Logging out."); await auth.signOut(); currentUser = null; }
            } else currentUser = null;
            setupSidebar(); 
            await handleRouteChange();
        });
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('register-form').addEventListener('submit', handleRegister);
        document.getElementById('google-login-btn').addEventListener('click', handleGoogleLogin);
        document.getElementById('save-profile-btn').addEventListener('click', handleSaveProfile);
        document.getElementById('resend-verification-btn').addEventListener('click', async () => { try { await auth.currentUser.sendEmailVerification(); showToast("Email ƒë√£ ƒë∆∞·ª£c g·ª≠i l·∫°i.", 'success'); } catch (e) { showToast("G·ª≠i email th·∫•t b·∫°i."); }});
        document.getElementById('forgot-password-form').addEventListener('submit', handleForgotPassword);
        importJsonInput.addEventListener('change', handleImportJson); 
        document.getElementById('footer-year').textContent = new Date().getFullYear();
        setupAuthForm();

        document.getElementById('project-detail-link-btn').addEventListener('click', (e) => handleProjectLinkActivation(e.currentTarget));
        document.getElementById('project-detail-share-btn').addEventListener('click', (e) => handleShareProject(e.currentTarget));
    }

    main();
});
</script>
</body>
</html>
